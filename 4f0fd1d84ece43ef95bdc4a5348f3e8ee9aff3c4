{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "876a8d91_d7c3c2d8",
        "filename": "copytool/queue.c",
        "patchSetId": 2
      },
      "lineNbr": 296,
      "author": {
        "id": 1019142
      },
      "writtenOn": "2025-12-09T08:28:23Z",
      "side": 1,
      "message": "IIRC, the cancel has the same kind of state management as any HSM request. When an action is canceled, Lustre marks the cancel request as \"success\" and the original request as \"canceled\". Looking at the HPSS copytool, it calls `llapi_hsm_action_end` with `HP_FLAG_COMPLETED` flags and the `ECANCELED` return code.",
      "range": {
        "startLine": 296,
        "startChar": 25,
        "endLine": 296,
        "endChar": 68
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b0bdd195_0a16c7fd",
        "filename": "copytool/queue.c",
        "patchSetId": 2
      },
      "lineNbr": 296,
      "author": {
        "id": 1003556
      },
      "writtenOn": "2025-12-09T19:59:32Z",
      "side": 1,
      "message": "The difference with the HPSS mover is that we haven\u0027t called llapi_hsm_action_begin yet at this point -- my understanding is that the llapi_hsm_action_end is required to free the internal hcp at the very least.\n\nFrom testing, the request is properly removed from the active_requests list on the coordinator, so I think this is correct -- I\u0027ll recheck and update the comment to say we didn\u0027t begin yet.",
      "parentUuid": "876a8d91_d7c3c2d8",
      "range": {
        "startLine": 296,
        "startChar": 25,
        "endLine": 296,
        "endChar": 68
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eb8bb1c0_d07a29ce",
        "filename": "copytool/queue.c",
        "patchSetId": 2
      },
      "lineNbr": 296,
      "author": {
        "id": 1019142
      },
      "writtenOn": "2025-12-10T08:18:29Z",
      "side": 1,
      "message": "The issue is not the request being cancel. This one is updated by the Lustre coordinator when the cancel is sent. The issue, I think, is the cancel request itself. The cancel is marked as a success when the copytool calls llapi_hsm_action_end. If you never call it, I expect the request to be in the started state until the timeout is reached. Looking at the MDS side of the code, I think the expected behavior is to call end on cancel to update the on disk state of the cancel request and generate an HSM changelog as well. Looking at the code on the MDS when llapi_hsm_action_begin is called, I don\u0027t see much being done. So the state of the request should be updated on end I think because the state is initialized before actually sending the request to the copytool.",
      "parentUuid": "b0bdd195_0a16c7fd",
      "range": {
        "startLine": 296,
        "startChar": 25,
        "endLine": 296,
        "endChar": 68
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e7c822e1_f7d70482",
        "filename": "copytool/queue.c",
        "patchSetId": 2
      },
      "lineNbr": 296,
      "author": {
        "id": 1003556
      },
      "writtenOn": "2025-12-11T13:35:21Z",
      "side": 1,
      "message": "hmm, I just downloaded the lastest lhsm hpss (1.2.1) from https://sourceforge.net/projects/lustrehpss/ and it doesn\u0027t do llapi_hsm_action_end (nor begin) on the HSMA_CANCEL event?\n\n- got hai from llapi_hsm_copytool_recv()\n- -\u003e handle_action_item()\n- -\u003e if (CANCEL), pthread_create thr_cancel()\n- -\u003e if cancel_action() failed then it reports an error to the coordinator by calling both begin and end, but if cancel worked then it does nothing at all -- the child process does catch SIGTERM and calls action end on the original request though\n\n\nWell, with that said I did re-check `lctl get_param -n mdt.*.hsm.active_requests` now and... the properly cancelled requests are pending there (with canceled\u003d1 set), so I guess the MDS doesn\u0027t really care and just need either event to be acknowleged, but since it\u0027s a request that was never sent out to a mover we need to do something alright... begin/end dance it is...\nI\u0027ll update next week-ish",
      "parentUuid": "eb8bb1c0_d07a29ce",
      "range": {
        "startLine": 296,
        "startChar": 25,
        "endLine": 296,
        "endChar": 68
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "249eecf3_8b1c5820",
        "filename": "copytool/queue.c",
        "patchSetId": 2
      },
      "lineNbr": 296,
      "author": {
        "id": 1003556
      },
      "writtenOn": "2026-01-18T12:39:58Z",
      "side": 1,
      "message": "Okay, so with a second look this (acknowledging either the cancel or the cancelled request) makes sense because they share the same fid/cookie: the coordinator doesn\u0027t track the two separately.\n\nI\u0027ve added explicit llapi_hsm_action_begin/end calls here as they should ; and I\u0027ve updated the test to check there\u0027s no leftover active requests on the coordinator after this.\n\nThe next two commits implement cancels sent to the client since it\u0027ll apparently be useful, but it\u0027s complex enough (as expected) that it deserves a bit more attention.",
      "parentUuid": "e7c822e1_f7d70482",
      "range": {
        "startLine": 296,
        "startChar": 25,
        "endLine": 296,
        "endChar": 68
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8b44bf27_7c7ee09b",
        "filename": "tests/run_tests.sh",
        "patchSetId": 2
      },
      "lineNbr": 759,
      "author": {
        "id": 1019142
      },
      "writtenOn": "2025-12-09T08:28:23Z",
      "side": 1,
      "message": "Wouldn\u0027t it be better to not start a mover but just the coordinatool? Then you would know that the request is in the wait queue. This would make sure that you are testing the code you wrote.\n\nIf my understanding is correct, I would expect:\n- the original archive to be in the canceled state\n- the cancel request to be in the started state\n\nTo make the cancel request a success, you would need to call `llapi_hsm_action_end` I think.",
      "range": {
        "startLine": 759,
        "startChar": 0,
        "endLine": 759,
        "endChar": 10
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ae6ee688_72dab375",
        "filename": "tests/run_tests.sh",
        "patchSetId": 2
      },
      "lineNbr": 759,
      "author": {
        "id": 1003556
      },
      "writtenOn": "2025-12-09T19:59:32Z",
      "side": 1,
      "message": "with the WAIT_FILE and the coordinatool.conf with max_archive\u003d3 we \"know\" that with 10 requests we have 3 on the mover and 7 in the internal coordinatool queues\n(or would know if we had a proper wait mechanism... but the problem\u0027s the same without a mover, we need to wait for lustre to send requests to the coordinatool)\n\nSo I think this tests things properly (with no cancel sent to the mover, exactly 3 transfers go through means all the 7 requests in coordinatool were successfully removed)\n\nThe test could check `lctl get_param -n mdt.*.hsm.active_requests` is empty at the end though, I\u0027ll update that next weekish",
      "parentUuid": "8b44bf27_7c7ee09b",
      "range": {
        "startLine": 759,
        "startChar": 0,
        "endLine": 759,
        "endChar": 10
      },
      "revId": "4f0fd1d84ece43ef95bdc4a5348f3e8ee9aff3c4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}